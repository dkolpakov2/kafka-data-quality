#version: "3.9"

services:
  # ============================================================
  # ZOOKEEPER
  # ============================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  # ============================================================
  # KAFKA BROKER
  # ============================================================
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1

  # ============================================================
  # CASSANDRA (ON-PREM)
  # ============================================================
  cassandra_onprem:
    image: cassandra:4.1
    container_name: cassandra_onprem
    environment:
      CASSANDRA_CLUSTER_NAME: "OnPremCluster"
      CASSANDRA_DC: "DC_ONPREM"
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
    ports:
      - "9042:9042"
    volumes:
      - cassandra_onprem_data:/var/lib/cassandra

  # ============================================================
  # CASSANDRA (CLOUD - SIMULATED)
  # ============================================================
  cassandra_cloud:
    image: cassandra:4.1
    container_name: cassandra_cloud
    environment:
      CASSANDRA_CLUSTER_NAME: "CloudCluster"
      CASSANDRA_DC: "DC_AZURE"
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
    ports:
      - "9142:9042"
    volumes:
      - cassandra_cloud_data:/var/lib/cassandra

  # ============================================================
  # FLINK
  # ============================================================
  jobmanager:
    image: flink:1.17-scala_2.12
    container_name: flink_jobmanager
    depends_on:
      - kafka    
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - JOB_MANAGER_RPC_ADDRESS=jobmanager

  taskmanager:
    image: flink:1.17-scala_2.12
    # container_name: flink_taskmanager
    depends_on:
      - jobmanager
    command: taskmanager
    environment:
      - JOB_MANAGER_RPC_ADDRESS=jobmanager
    deploy:
      replicas: 2

  # ============================================================
  # ZEPPELIN (Flink SQL Notebooks)
  # ============================================================
  zeppelin:
    image: apache/zeppelin:0.10.1
    depends_on:
      - jobmanager
      - taskmanager
    ports:
      - "8080:8080"
    environment:
      ZEPPELIN_JAVA_OPTS: >
        -Dzeppelin.flink.ui.enabled=true
        -Dzeppelin.flink.run.as.session=true
        -DFLINK_HOME=/opt/flink
    volumes:
      - ./zeppelin/notebooks:/zeppelin/notebook
      - ./zeppelin/conf:/zeppelin/conf

  # ============================================================
  # PYTHON DQ RULE GENERATOR (OPTIONAL)
  # ============================================================
  dq_generator:
    build:
      context: ./tools
    container_name: dq_sql_generator
    volumes:
      - ./rules:/rules
      - ./generated_sql:/generated_sql
    command: >
      python rules_to_sql.py /rules/rules.yaml --output /generated_sql/compiled.sql

  # ============================================================
  # DATADOG AGENT (metrics from valid/invalid counters)
  # ============================================================
  datadog:
    image: gcr.io/datadoghq/agent:latest
    environment:
      DD_API_KEY: "${DD_API_KEY}"
      DD_SITE: "datadoghq.com"
      DD_LOGS_ENABLED: "true"
      DD_CONTAINER_EXCLUDE: "name:datadog"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

volumes:
  cassandra_onprem_data:
  cassandra_cloud_data:
